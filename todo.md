# 股票监控软件优化计划

基于对项目结构和代码的分析，我发现了几个可以优化的地方，包括性能、体积和资源占用方面的改进：

## 1. 数据文件优化 ✅ 已完成

**解决方案**：
- ✅ 按需加载：只加载用户关注的股票数据
- ✅ 分离数据：将港股、A股、指数等数据存储在SQLite数据库中
- ✅ 压缩存储：使用SQLite数据库替代JSON文件，提高查询效率

## 2. 依赖优化 ✅ 已完成

**问题**：从 requirements.txt 可以看出，项目依赖较多：
- PyQt5（GUI 框架）
- easyquotation（行情数据）
- pypinyin（拼音处理）
- pywin32（Windows 特定功能）
- pandas、openpyxl（Excel 处理）
- requests（网络请求）
- zhconv（繁简转换）

**已完成优化**：
- ✅ 移除未使用的依赖项（pandas）
- ✅ 使用更轻量级的替代方案（用openpyxl替代pandas处理Excel文件）
- ✅ 对于只用到部分功能的库，考虑只导入需要的模块
- ✅ 根据实际需求更新依赖项，添加pandas以支持Excel文件读取

## 3. 构建优化

**问题**：从 build.py 和 stock_monitor.spec 可以看出：
- 打包时包含了完整的股票数据文件
- 包含了 easyquotation 的配置文件

**建议**：
- 使用 UPX 压缩可执行文件
- 按需打包数据文件
- 优化 PyInstaller 的打包配置，移除未使用的模块

## 4. 性能优化建议

### 4.1 启动性能 ✅ 部分完成
- ✅ 延迟加载：将部分非核心模块改为按需加载，如拼音处理、设置对话框等
- ✅ 异步初始化：将耗时的初始化操作（如行情引擎）放在后台线程进行
- 待办：进一步优化其他模块的延迟加载

### 4.2 数据库优化
- ✅ 使用SQLite数据库替代JSON文件，提高查询效率
- ✅ 实现索引优化，加快搜索速度
- ✅ 支持按需查询，只加载需要的数据

## 5. 功能优化建议

### 5.1 用户体验
- 支持更多的自定义选项
- 增加键盘快捷键支持
- 改进错误提示和用户引导

### 5.2 数据处理 ✅ 部分完成
- ✅ 增加数据缓存机制，减少网络请求
- ✅ 优化数据更新策略，避免频繁更新
- ✅ 增加数据备份和恢复功能
- 待办：增加数据同步机制，确保数据实时性

## 6. 代码结构优化

### 6.1 模块划分
当前项目结构已经比较清晰，但可以进一步优化：
```
stock_monitor/
├── config/          # 配置管理
├── data/            # 数据处理
│   ├── market/      # 行情数据相关
│   └── stock/       # 股票基础数据相关
├── network/         # 网络请求
├── ui/              # 界面组件
├── utils/           # 工具函数
└── core/            # 核心业务逻辑
```

### 6.2 职责分离
- 将行情数据获取逻辑从 main.py 中分离出来
- 将 UI 更新逻辑进一步细化
- 增加业务逻辑层，减少 UI 和数据层的耦合

## 7. 具体优化措施

### 7.1 减小可执行文件体积
**精简依赖**：
- 检查是否真的需要 pandas 和 openpyxl，考虑用更轻量级的库替代
- 只打包实际使用的 PyQt5 模块

**数据文件优化**：✅ 已完成
- 将完整的股票数据文件拆分为多个小文件 ✅ 已完成
- 实现按需下载机制，只下载用户需要的股票数据

### 7.2 内存占用优化
- 对象池：为 QTableWidgetItem 创建对象池，避免频繁创建和销毁对象
- 智能缓存：根据使用频率和重要性设置不同的缓存策略
- 及时释放：确保不需要的对象能够被及时垃圾回收

### 7.3 启动速度优化
- ✅ 延迟初始化：将非必要的初始化操作推迟到实际使用时进行
- ✅ 后台加载：将数据加载等耗时操作放在后台线程执行
- 待办：实现智能预加载机制，预测用户可能需要的数据

### 7.4 搜索功能优化 ✅ 已完成
- ✅ 修复港股搜索功能，支持不带'hk'前缀的港股代码搜索
- ✅ 优化搜索算法，提升搜索结果相关性
- ✅ 解决港股数据获取问题，确保获取完整数据

---

这些优化措施可以帮助减小应用程序体积、降低内存占用并提高启动速度和运行性能。建议优先处理数据文件优化和依赖精简，这两项对减小体积和内存占用的效果最为明显。

# 优化任务清单

## 已完成任务

### 1. 数据存储优化
- [x] 将数据存储从JSON迁移到SQLite数据库
- [x] 实现按需查询机制，提高查询效率
- [x] 添加数据库索引以提高查询速度

### 2. 港股数据获取修复
- [x] 修复港股数据获取问题，使用pandas替代openpyxl读取Excel文件
- [x] 确保获取完整的港股数据（从1.3MB的Excel文件中）

### 3. UI布局优化
- [x] 统一使用布局管理器，避免混用绝对定位和布局管理器
- [x] 合理设置控件的SizePolicy，让控件能够根据内容自动调整大小
- [x] 使用样式表进行微调，通过padding和margin进行精细调整
- [x] 避免过度嵌套，减少不必要的容器嵌套

### 4. 启动性能优化
- [x] 实现延迟加载和异步初始化优化启动性能

### 5. 依赖项优化
- [x] 添加pandas依赖以支持Excel文件读取
- [x] 保留openpyxl依赖用于其他可能的Excel处理需求

### 6. 模块划分优化
- [x] 当前项目结构已经比较清晰，按以下方式进一步优化：
```
stock_monitor/
├── config/          # 配置管理
├── data/            # 数据处理
│   ├── market/      # 行情数据相关
│   └── stock/       # 股票基础数据相关
├── network/         # 网络请求
├── ui/              # 界面组件
├── utils/           # 工具函数
└── core/            # 核心业务逻辑
```

## 待办任务

### 1. 代码清理
- [ ] 移除未使用的导入语句
- [ ] 清理冗余的注释和代码
- [ ] 检查是否有重复的功能实现

### 2. 性能进一步优化
- [ ] 优化搜索算法，提高搜索响应速度
- [ ] 增加更多的缓存机制
- [ ] 优化数据库查询语句

### 3. 用户体验优化
- [ ] 改进错误提示信息
- [ ] 增加加载状态提示
- [ ] 优化界面响应速度

### 4. 代码质量提升
- [ ] 增加单元测试覆盖
- [ ] 完善文档注释
- [ ] 统一代码风格
