# 绿色软件更新方案分析

针对 Windows 平台绿色版（Portable）软件，常见的更新方案有以下几种。鉴于目前"独立 EXE 更新程序"遇到的进程锁死和复杂性问题，我们重点比较更简单、更原生的方案。

## 方案一：BAT/CMD 脚本更新 (推荐)

这是最传统但也最**简单、粗暴、有效**的方案。几乎所有 Windows 绿色软件（如早期的 Notepad++ 等）都用过类似机制。

*   **原理**:
    1.  主程序下载更新包并解压到临时目录。
    2.  主程序生成一个临时脚本 `update.bat`。
    3.  主程序启动脚本，并立即自我终结 (`os._exit(0)`).
    4.  **脚本逻辑**:
        *   死循环检测主程序进程是否存在。
        *   一旦主程序消失，通过系统命令 (`move /y`, `xcopy`) 强制覆盖文件。
        *   重新启动主程序。
        *   自删除。

*   **优点**:
    *   **极简**: 不需要编译额外的 `updater.exe`，没有 PyInstaller 打包依赖。
    *   **透明**: 脚本是文本文件，出错了一目了然，方便调试。
    *   **强力**: Windows 的 CMD 命令处理文件操作非常成熟。

*   **缺点**:
    *   **界面简陋**: 更新时会弹出一个黑色的 CMD 窗口（虽然可以隐藏，但完全隐藏可能导致用户以为软件挂了）。

## 方案二：启动器模式 (Launcher) - 深度解析

### 1. 核心架构
这实际上是把项目变成了**两个独立的软件**：
*   **Launcher.exe**: "门卫"。极其轻量，除了检查更新和启动主程序外什么都不干。**它永远不关闭，也不更新自己**。
*   **Application.exe**: "老板"。真正的主程序。

### 2. 目录结构的变化 (最大变化点)
您现在的目录是扁平的：
```text
D:\StockMonitor\
  ├── stock_monitor.exe  <-- 用户双击这个 (也是被锁定的文件)
  ├── _internal/         <-- 依赖库
```

采用 Launcher 后，目录结构必须变成两层：
```text
D:\StockMonitor\
  ├── StockLauncher.exe  <-- 用户必须改习惯，双击这个 "门卫"
  ├── bin\               <-- "老板"躲在子目录里
  │   ├── stock_monitor.exe
  │   ├── _internal/
  │   └── ...
```

### 3. 实现复杂度
*   **双工程加倍**: 我们需要维护两套代码、两个 `pyproject.toml`、两个构建流程。
    *   工程A: 现有的 `StockMonitor`
    *   工程B: 新的 `Launcher` (需用 Python 或 C++ 写)
*   **打包变慢**: 每次发布release，GitHub Actions 要先编译A，再编译B，然后把它们按特定目录结构拼在一起打包。
*   **自身更新悖论**: 如果有一天 "门卫" (Launcher) 自己也需要更新怎么办？那时候又回到了死循环——需要第三个程序来更新门卫。通常 Launcher 写死后就不再更新。

### 4. 总结
*   **复杂度**: 高 (从开发到打包全流程翻倍)
*   **稳定性**: 极高 (因为更新时只替换 `bin` 目录，Launcher 自身没被锁定)
*   **适合场景**: 只有像《魔兽世界》或 IDE 等大型商业软件，为了极致的用户体验才值得投入这么大精力。


## 方案三：当前方案 (独立 Python Updater)

*   **原理**: 编译一个 Python 写的 `updater.exe` 来做替换。
*   **当前问题**:
    *   `updater.exe` 本身也是 pyinstaller 打包的，启动慢，依赖多。
    *   进程通信复杂（PID 检测在 Windows 上有时不准）。
    *   **过度设计**: 对于一个小工具来说，维护两个 PyInstaller 工程太重了。

---

## 建议

考虑到您的项目是**绿色版小工具**，不管是**方案一 (BAT脚本)** 还是 **方案二 (启动器)** 都比现在的方案好。

**推荐选择：方案一 (BAT 脚本)**

**理由**:
1.  **代码量最少**: 只需要在主程序里写几十行生成 `.bat` 的代码。
2.  **成功率高**: 只要主程序退出了，CMD 脚本一定能把文件移过去。
3.  **立刻见效**: 不需要重构目录，不需要让用户改习惯。

如果您接受更新时出现几秒钟的 CMD 黑窗口（可以显示"正在更新..."字样），这是目前**性价比最高**的改动。

### 方案一的各种变体对比

| 特性 | 纯 BAT 脚本 | VBS 脚本 | PowerShell 脚本 |
| :--- | :--- | :--- | :--- |
| **界面** | 黑窗口 | 无界面/弹窗 | 蓝窗口/可隐藏 |
| **可靠性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| **防杀软** | 高 | 中 (易被拦截) | 中 (执行策略限制) |
| **维护** | 容易 | 一般 | 容易 |

**最终建议**: 使用 **纯 BAT 脚本**，简单就是美。
