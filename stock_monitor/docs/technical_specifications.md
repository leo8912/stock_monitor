# 技术规格说明

## 版本信息

当前版本: v2.2.6

## 技术栈

- **编程语言**: Python 3.7+
- **GUI框架**: PyQt6
- **行情数据源**: easyquotation
- **汉字拼音处理**: pypinyin
- **版本检测**: packaging
- **Windows系统集成**: pywin32
- **HTTP请求**: requests
- **数据处理**: pandas
- **中文繁简转换**: zhconv
- **Excel处理**: openpyxl

## 项目架构

本项目采用模块化单体应用架构，各模块职责明确：

1. **UI层** (`ui/`): 负责界面展示和用户交互
2. **业务逻辑层** (`core/`): 处理核心业务逻辑
3. **数据层** (`data/`): 负责数据获取、处理和存储
4. **网络层** (`network/`): 处理网络通信
5. **配置层** (`config/`): 管理应用配置
6. **工具层** (`utils/`): 提供通用工具函数

## 核心组件

### 1. 主窗口 (MainWindow)
位于 `main.py`，是应用的核心控制器，负责：
- 初始化UI组件
- 管理后台线程
- 处理用户交互事件
- 协调各模块工作

### 2. 配置管理器 (ConfigManager)
位于 `config/manager.py`，采用单例模式设计：
- 统一配置文件读写
- 提供配置项的获取和设置接口
- 自动创建默认配置

### 3. 股票服务 (StockDataService)
位于 `core/stock_service.py`，提供统一的股票数据获取接口：
- 支持A股、港股等不同类型股票
- 实现数据获取重试机制
- 处理数据格式标准化

### 4. 刷新工作线程 (RefreshWorker)
位于 `core/refresh_worker.py`，负责后台数据刷新：
- 定时获取股票实时行情
- 根据市场开闭市状态调整刷新频率
- 通过信号机制与UI线程通信

### 5. 缓存系统
项目实现了两级缓存机制：

#### 全局数据缓存 (global_cache)
位于 `utils/cache.py`:
- 使用LRU策略的通用数据缓存
- 默认TTL: 30秒
- 最大容量: 1000项
- 市场感知TTL: 开市期间30秒，闭市期间300秒

#### 股票基础数据缓存 (global_stock_cache)
位于 `utils/stock_cache.py`:
- 专门缓存股票基础数据
- TTL: 300秒（5分钟）
- 数据来源于 SQLite 数据库
## 数据流设计

```
[用户操作] 
    ↓
[UI层] ←→ [配置管理器]
    ↓
[业务逻辑层]
    ↓
[数据层] ←→ [网络层]
    ↓
[缓存系统]
    ↓
[UI更新]
```

## 网络通信

### 行情数据获取
使用 `easyquotation` 库获取实时行情数据：
- A股数据: 使用sina行情引擎
- 港股数据: 使用hkquote行情引擎

### 更新检测
通过GitHub API检测新版本：
- 主地址: https://api.github.com/repos/leo8912/stock_monitor/releases/latest
- 备用地址: https://ghfast.top/https://api.github.com/repos/leo8912/stock_monitor/releases/latest

## 存储设计

### 配置存储
- 位置: `.stock_monitor/config.json`
- 内容: 用户自选股、刷新频率、窗口位置等配置

### 数据存储
- 位置: `stocks.db` SQLite数据库
- 内容: 股票基础数据（代码、名称、拼音等）### 日志存储
- 位置: `logs/`
- 策略: 自动清理7天前的日志文件

## 更新机制

采用两阶段更新策略：
1. 下载并解压新版本到临时目录
2. 应用重启时替换旧版本文件

特点：
- 支持断点续传
- 更新过程中保留用户配置
- 失败时自动回滚

## 界面设计

### 主界面
- 无边框透明窗口
- 支持拖拽移动
- 右键菜单操作
- 实时行情展示

### 设置界面
- 自选股管理（搜索、添加、删除、排序）
- 显示设置（字体、主题、透明度）
- 系统设置（开机启动、刷新频率、版本信息）

## 性能优化

### 数据缓存
- 实时行情数据缓存30秒
- 股票基础数据缓存5分钟
- LRU策略自动淘汰过期数据
- 动态调整LRU缓存大小，根据系统资源自动优化缓存容量

### 请求合并
- 批量获取多只股票数据
- 减少网络请求次数

### 线程分离
- 后台线程处理数据获取
- UI线程专注界面渲染
- 避免界面卡顿

### 优化效果
- 股票数据处理性能：每秒处理80+只股票
- 缓存命中时性能提升超过100倍
- 平均每次迭代耗时：0.06秒

## 安全设计

### 数据校验
- 股票数据完整性验证
- 防止不完整数据被缓存

### 错误处理
- 网络异常重试机制
- 异常信息记录日志
- 用户友好错误提示

### 配置保护
- JSON格式损坏自动恢复
- 配置文件权限检查
- 默认配置自动创建

## 绿色软件特性

- 所有数据存储在程序目录下
- 不向系统注册表写入信息
- 支持直接复制目录迁移
- 解除依赖外部运行环境