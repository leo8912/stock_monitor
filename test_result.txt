============================= test session starts =============================
platform win32 -- Python 3.13.11, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\leo89\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
metadata: {'Python': '3.13.11', 'Platform': 'Windows-11-10.0.26200-SP0', 'Packages': {'pytest': '9.0.2', 'pluggy': '1.6.0'}, 'Plugins': {'anyio': '4.12.1', 'asyncio': '1.3.0', 'cov': '7.0.0', 'html': '4.2.0', 'json-report': '1.5.0', 'metadata': '3.1.1', 'qt': '4.5.0'}, 'JAVA_HOME': 'C:\\Program Files\\Java\\jdk-17'}
PySide6 6.10.2 -- Qt runtime 6.10.2 -- Qt compiled 6.10.2
rootdir: D:\code\stock
configfile: pyproject.toml
plugins: anyio-4.12.1, asyncio-1.3.0, cov-7.0.0, html-4.2.0, json-report-1.5.0, metadata-3.1.1, qt-4.5.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 70 items

tests/integration/test_market_data.py::test_market_snapshot PASSED       [  1%]
tests/integration/test_market_data.py::test_market_indices PASSED        [  2%]
tests/integration/test_market_data.py::test_all_method PASSED            [  4%]
tests/integration/test_market_snapshot.py::test_market_snapshot_detail PASSED [  5%]
tests/integration/test_realtime.py::test_realtime_comparison PASSED      [  7%]
tests/integration/test_simple_extraction.py::test_extraction PASSED      [  8%]
tests/integration/test_updater_extraction.py::test_updater_extraction PASSED [ 10%]
tests/smoke/test_gui_smoke.py::test_main_window_init FAILED              [ 11%]

================================== FAILURES ===================================
____________________________ test_main_window_init ____________________________

qtbot = <pytestqt.qtbot.QtBot object at 0x000001C85D54C440>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001C85CF163F0>

    def test_main_window_init(qtbot, monkeypatch):
        """
        GUI鍐掔儫娴嬭瘯锛氶獙璇佷富绐楀彛鑳藉惁姝ｅ父鍒濆鍖?
        """
        # 妯℃嫙鏁版嵁闃叉鑷姩鏇存柊瑙﹀彂缃戠粶璇锋眰
        stock_db = container.get(StockDatabase)
        monkeypatch.setattr(stock_db, "is_empty", lambda: False)
        monkeypatch.setattr(stock_db, "get_all_stocks", lambda: [])
    
        # 妯℃嫙 RefreshWorker 闃叉绾跨▼鏈€€鍑哄鑷村穿婧?
        from unittest.mock import MagicMock
    
        mock_worker = MagicMock()
        # 纭繚 data_updated 鍜?refresh_error 淇″彿瀛樺湪
        mock_worker.data_updated.connect = MagicMock()
        mock_worker.refresh_error.connect = MagicMock()
        mock_worker.start_refresh = MagicMock()
    
        # 鏇挎崲 ViewModel 涓殑 Workers
        import stock_monitor.ui.view_models.main_window_view_model
    
        monkeypatch.setattr(
            stock_monitor.ui.view_models.main_window_view_model, "RefreshWorker", lambda: mock_worker
        )
    
        # Mock MarketStatsWorker as well
        mock_market_worker = MagicMock()
        mock_market_worker.stats_updated.connect = MagicMock()
        mock_market_worker.start_worker = MagicMock()
    
        monkeypatch.setattr(
            stock_monitor.ui.view_models.main_window_view_model, "MarketStatsWorker", lambda: mock_market_worker
        )
    
        # 鍒濆鍖栦富绐楀彛
        window = MainWindow()
>       qtbot.addWidget(window)

tests\smoke\test_gui_smoke.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <pytestqt.qtbot.QtBot object at 0x000001C85D54C440>
widget = <stock_monitor.ui.main_window.MainWindow object at 0x000001C85D586A30>

    def addWidget(
        self, widget: QWidget, *, before_close_func: Optional[BeforeCloseFunc] = None
    ) -> None:
        """
        Adds a widget to be tracked by this bot. This is not required, but will ensure that the
        widget gets closed by the end of the test, so it is highly recommended.
    
        :param QWidget widget:
            Widget to keep track of.
    
        :kwparam before_close_func:
            A function that receives the widget as single parameter, which is called just before
            the ``.close()`` method gets called.
    
        .. note:: This method is also available as ``add_widget`` (pep-8 alias)
        """
        if not isinstance(widget, qt_api.QtWidgets.QWidget):
>           raise TypeError(f"Need to pass a QWidget to addWidget: {widget!r}")
E           TypeError: Need to pass a QWidget to addWidget: <stock_monitor.ui.main_window.MainWindow object at 0x000001C85D586A30>

C:\Users\leo89\AppData\Local\Programs\Python\Python313\Lib\site-packages\pytestqt\qtbot.py:221: TypeError
---------------------------- Captured stderr call -----------------------------
2026-02-24 12:04:51,690 | INFO     | 浣跨敤閰嶇疆鐩綍: D:\code\stock\stock_monitor\.stock_monitor
2026-02-24 12:04:51,691 | INFO     | 鑲＄エ鏁版嵁搴撳垵濮嬪寲瀹屾垚
2026-02-24 12:04:51,694 | INFO     | 鑲＄エ鏁版嵁鏈嶅姟鍒濆鍖栧畬鎴?
2026-02-24 12:04:51,702 | INFO     | 涓荤獥鍙ｅ垵濮嬪寲寮€濮?
2026-02-24 12:04:51,702 | INFO     | 宸插惎鍔ㄦ棩蹇楀畾鏈熸竻鐞嗕换鍔★紝淇濈暀 7 澶╂棩蹇楋紝姣?24 灏忔椂娓呯悊涓€娆?
2026-02-24 12:04:51,717 | INFO     | 鏃ュ織娓呯悊瀹屾垚锛屽垹闄や簡 0 涓繃鏈熸棩蹇楁枃浠?
2026-02-24 12:04:51,719 | INFO     | Loaded user stock list: ['sh600487', 'sh600111', 'sz000333', 'sz002055', 'sh600460', 'sz001380', 'sh603986', 'sh688017']
2026-02-24 12:04:51,720 | INFO     | 鍒濆鍖栭厤缃? 鍒锋柊闂撮殧=5, 鑷€夎偂=['sh600487', 'sh600111', 'sz000333', 'sz002055', 'sh600460', 'sz001380', 'sh603986', 'sh688017']
2026-02-24 12:04:51,854 | INFO     | 涓荤獥鍙ｅ垵濮嬪寲瀹屾垚
------------------------------ Captured log call ------------------------------
INFO     stock_monitor:manager.py:23 浣跨敤閰嶇疆鐩綍: D:\code\stock\stock_monitor\.stock_monitor
INFO     stock_monitor:stock_db.py:81 鑲＄エ鏁版嵁搴撳垵濮嬪寲瀹屾垚
INFO     stock_monitor:stock_service.py:35 鑲＄エ鏁版嵁鏈嶅姟鍒濆鍖栧畬鎴?
INFO     stock_monitor:main_window.py:129 涓荤獥鍙ｅ垵濮嬪寲寮€濮?
INFO     stock_monitor:log_cleaner.py:79 宸插惎鍔ㄦ棩蹇楀畾鏈熸竻鐞嗕换鍔★紝淇濈暀 7 澶╂棩蹇楋紝姣?24 灏忔椂娓呯悊涓€娆?
INFO     stock_monitor:log_cleaner.py:52 鏃ュ織娓呯悊瀹屾垚锛屽垹闄や簡 0 涓繃鏈熸棩蹇楁枃浠?
INFO     stock_monitor:main_window_view_model.py:95 Loaded user stock list: ['sh600487', 'sh600111', 'sz000333', 'sz002055', 'sh600460', 'sz001380', 'sh603986', 'sh688017']
INFO     stock_monitor:main_window.py:219 鍒濆鍖栭厤缃? 鍒锋柊闂撮殧=5, 鑷€夎偂=['sh600487', 'sh600111', 'sz000333', 'sz002055', 'sh600460', 'sz001380', 'sh603986', 'sh688017']
INFO     stock_monitor:main_window.py:247 涓荤獥鍙ｅ垵濮嬪寲瀹屾垚
-------------------------- Captured stderr teardown ---------------------------
2026-02-24 12:04:52,029 | INFO     | 绐楀彛宸插己鍒舵樉绀?
---------------------------- Captured log teardown ----------------------------
INFO     stock_monitor:main_window.py:371 绐楀彛宸插己鍒舵樉绀?
============================== warnings summary ===============================
C:\Users\leo89\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\__init__.py:113
  C:\Users\leo89\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\__init__.py:113: RequestsDependencyWarning: urllib3 (2.6.3) or chardet (6.0.0.post1)/charset_normalizer (3.4.4) doesn't match a supported version!
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/smoke/test_gui_smoke.py::test_main_window_init - TypeError: Need to pass a QWidget to addWidget: <stock_monitor.ui.main_window.MainWindow object at 0x000001C85D586A30>
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!
=================== 1 failed, 7 passed, 1 warning in 12.35s ===================
