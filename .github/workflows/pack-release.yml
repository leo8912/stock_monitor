name: æ‰“åŒ…å¹¶è‡ªåŠ¨å‘å¸ƒè‚¡ç¥¨ç›‘æ§åº”ç”¨ # Pack & Auto Release Stock Monitor

on:
  push:
    paths:
      - 'stock_monitor/version.py'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

permissions:
  contents: write  # å†™å…¥ä»“åº“å†…å®¹æƒé™
  packages: write  # å†™å…¥åŒ…æƒé™

jobs:
  build:
    runs-on: windows-latest  # åœ¨æœ€æ–°çš„Windowsç¯å¢ƒä¸‹è¿è¡Œ

    steps:
    - name: æ£€å‡ºä»£ç  # Checkout code
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ # Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: å®‰è£…ä¾èµ–é¡¹ # Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install pyinstaller

    - name: éªŒè¯æ‰€éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨ # Verify required files exist
      run: |
        echo "æ£€æŸ¥æ‰€éœ€æ–‡ä»¶:"
        Get-ChildItem stock_monitor/resources/
        echo "å›¾æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
        Test-Path stock_monitor/resources/icon.ico
        echo "è‚¡ç¥¨æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
        Test-Path stock_monitor/resources/stock_basic.json

    - name: æŸ¥æ‰¾easyquotationçš„stock_codes.confæ–‡ä»¶ # Find easyquotation stock_codes.conf
      id: find_eq
      run: |
        python -c "import easyquotation, os; print(os.path.dirname(easyquotation.__file__))" > eq_path.txt
        $EQPATH = Get-Content eq_path.txt | Select-Object -First 1
        echo "EQPATH=$EQPATH" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: è¿è¡Œæµ‹è¯• # Run tests
      run: |
        python -m pytest tests/
    
    - name: ä½¿ç”¨PyInstalleræ„å»º # Build with PyInstaller
      run: |
        pyinstaller -y -w -i stock_monitor/resources/icon.ico -n stock_monitor stock_monitor/main.py `
          --add-data "$env:EQPATH\stock_codes.conf;easyquotation" `
          --add-data "stock_monitor/resources/stock_basic.json;stock_monitor/resources" `
          --add-data "stock_monitor/resources/icon.ico;stock_monitor/resources" `
          --hidden-import=pypinyin `
          --hidden-import=pypinyin.style

    - name: åˆ—å‡ºdistç›®å½•å†…å®¹ # List dist directory
      run: |
        ls dist

    - name: å‹ç¼©äº§ç‰©(æ•´ä¸ªstock_monitoræ–‡ä»¶å¤¹) # Zip artifact (entire stock_monitor folder)
      run: |
        powershell Compress-Archive -Path dist/stock_monitor/* -DestinationPath stock_monitor.zip

    - name: ä¸Šä¼ äº§ç‰© # Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: stock-monitor
        path: stock_monitor.zip

    - name: ç¼–å†™ç‰ˆæœ¬æå–è„šæœ¬ # Write version extract script
      shell: bash
      run: |
        echo "import re" > get_version.py
        echo "s=open('stock_monitor/version.py',encoding='utf-8').read()" >> get_version.py
        echo "m=re.search(r\"__version__\\s*=\\s*['\\\"]([\\d\\.]+)['\\\"]\", s)" >> get_version.py
        echo "print(f'version=v{m.group(1)}' if m else 'version=unknown')" >> get_version.py

    - name: ä»main.pyè·å–ç‰ˆæœ¬å· # Get version from main.py
      id: get_version
      shell: bash
      run: |
        version=$(python get_version.py)
        echo "version=${version#version=}" >> $GITHUB_OUTPUT

    - name: ä»CHANGELOG.mdæå–æ›´æ–°æ—¥å¿— # Extract changelog from CHANGELOG.md
      id: extract_changelog
      shell: python
      run: |
        import re
        # è¯»å–ç‰ˆæœ¬å·
        version = "${{ steps.get_version.outputs.version }}"
        print(f"å¤„ç†ç‰ˆæœ¬å·: {version}")
        
        # å»æ‰å¼€å¤´çš„'v'å­—ç¬¦ï¼Œç¡®ä¿åŒ¹é…
        if version.startswith('v'):
            version = version[1:]
        
        # è¯»å–CHANGELOG.mdæ–‡ä»¶å¹¶æå–æŒ‡å®šç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
        with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
            content = f.read()
        
        print(f"å¤„ç†åçš„ç‰ˆæœ¬å·: {version}")
        print("CHANGELOG.md æ–‡ä»¶å†…å®¹å‰200å­—ç¬¦:")
        print(content[:200])
        
        # æ„é€ æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ç‰¹å®šç‰ˆæœ¬çš„æ—¥å¿—
        # åŒ¹é… ## [v2.0.4] - 2025-12-10 æˆ– ## [v2.0.4] è¿™æ ·çš„æ ¼å¼
        pattern = r"## \[" + re.escape("v" + version) + r"\](.*?)(?=## \[v|\Z)"
        print(f"ä½¿ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼: {pattern}")
        match = re.search(pattern, content, re.DOTALL)
        
        if match:
            changelog = match.group(1).strip()
            print("æˆåŠŸæå–æ—¥å¿—:")
            print(repr(changelog))
        else:
            changelog = "æš‚æ— è¯¦ç»†æ›´æ–°æ—¥å¿—"
            print("æœªæ‰¾åˆ°åŒ¹é…çš„æ—¥å¿—")
        
        # è¾“å‡ºåˆ°GitHub Actions
        with open('${GITHUB_OUTPUT}', 'a', encoding='utf-8') as f:
            f.write('changelog<<EOF\n')
            f.write(changelog + '\n')
            f.write('EOF\n')
        print("æ—¥å¿—æå–å®Œæˆ")

    - name: åˆ›å»ºå‘å¸ƒ # Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: stock_monitor.zip
        tag_name: stock_monitor_${{ steps.get_version.outputs.version }}
        name: stock_monitor_${{ steps.get_version.outputs.version }}
        body: |
          ğŸ¤– stock_monitor_${{ steps.get_version.outputs.version }} å‘å¸ƒè¯´æ˜
          
          > **æœ¬è½¯ä»¶å®Œå…¨ç”±AIè‡ªåŠ¨å¼€å‘ï¼Œå¼€å‘è€…é›¶åŸºç¡€ï¼Œæ‰€æœ‰åŠŸèƒ½å‡ç”±AIæ™ºèƒ½ç”Ÿæˆã€‚**
          
          ${{ steps.extract_changelog.outputs.changelog }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}