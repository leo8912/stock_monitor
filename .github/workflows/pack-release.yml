name: æ‰“åŒ…å¹¶è‡ªåŠ¨å‘å¸ƒè‚¡ç¥¨ç›‘æ§åº”ç”¨ # Pack & Auto Release Stock Monitor

on:
  push:
    paths:
      - 'stock_monitor/**'
      - 'requirements.txt'
      - '.github/workflows/pack-release.yml'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

permissions:
  contents: write  # å†™å…¥ä»“åº“å†…å®¹æƒé™
  packages: write  # å†™å…¥åŒ…æƒé™

jobs:
  build:
    runs-on: windows-latest  # åœ¨æœ€æ–°çš„Windowsç¯å¢ƒä¸‹è¿è¡Œ

    steps:
    - name: æ£€å‡ºä»£ç  # Checkout code
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ # Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: å®‰è£…ä¾èµ–é¡¹ # Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install pyinstaller

    - name: éªŒè¯æ‰€éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨ # Verify required files exist
      run: |
        echo "æ£€æŸ¥æ‰€éœ€æ–‡ä»¶:"
        Get-ChildItem stock_monitor/resources/
        echo "å›¾æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
        Test-Path stock_monitor/resources/icon.ico
        echo "è‚¡ç¥¨æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
        Test-Path stock_monitor/resources/stock_basic.json

    - name: æŸ¥æ‰¾easyquotationçš„stock_codes.confæ–‡ä»¶ # Find easyquotation stock_codes.conf
      id: find_eq
      run: |
        python -c "import easyquotation, os; print(os.path.dirname(easyquotation.__file__))" > eq_path.txt
        $EQPATH = Get-Content eq_path.txt | Select-Object -First 1
        echo "EQPATH=$EQPATH" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: è¿è¡Œæµ‹è¯• # Run tests
      run: |
        python -m pytest tests/
    
    - name: ä½¿ç”¨PyInstalleræ„å»º # Build with PyInstaller
      run: |
        pyinstaller -y -w -i stock_monitor/resources/icon.ico -n stock_monitor stock_monitor/main.py `
          --add-data "$env:EQPATH\stock_codes.conf;easyquotation" `
          --add-data "stock_monitor/resources/stock_basic.json;stock_monitor/resources" `
          --add-data "stock_monitor/resources/icon.ico;stock_monitor/resources" `
          --hidden-import=pypinyin `
          --hidden-import=pypinyin.style

    - name: åˆ—å‡ºdistç›®å½•å†…å®¹ # List dist directory
      run: |
        ls dist

    - name: å‹ç¼©äº§ç‰©(æ•´ä¸ªstock_monitoræ–‡ä»¶å¤¹) # Zip artifact (entire stock_monitor folder)
      run: |
        powershell Compress-Archive -Path dist/stock_monitor/* -DestinationPath stock_monitor.zip

    - name: ä¸Šä¼ äº§ç‰© # Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: stock-monitor
        path: stock_monitor.zip

    - name: ç¼–å†™ç‰ˆæœ¬æå–è„šæœ¬ # Write version extract script
      shell: bash
      run: |
        echo "import re" > get_version.py
        echo "s=open('stock_monitor/version.py',encoding='utf-8').read()" >> get_version.py
        echo "m=re.search(r\"__version__\\s*=\\s*['\\\"]([\\d\\.]+)['\\\"]\", s)" >> get_version.py
        echo "print(f'version=v{m.group(1)}' if m else 'version=unknown')" >> get_version.py

    - name: ä»main.pyè·å–ç‰ˆæœ¬å· # Get version from main.py
      id: get_version
      shell: bash
      run: |
        version=$(python get_version.py)
        echo "version=${version#version=}" >> $GITHUB_OUTPUT

    - name: ä»CHANGELOG.mdæå–æ›´æ–°æ—¥å¿— # Extract changelog from CHANGELOG.md
      id: extract_changelog
      shell: bash
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        # ä½¿ç”¨awkæå–æŒ‡å®šç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
        changelog=$(awk -v ver="$VERSION" '
        BEGIN { found=0; content="" }
        /^## \[v[^\]]*\]/ { 
          if (found==1) exit;
          if (index($0, "[v" ver "]") > 0) found=1;
          next
        }
        found==1 { 
          content = content $0 "\n" 
        }
        END { 
          if (length(content) > 0) {
            printf "%s", content
          } else {
            printf "æš‚æ— æ›´æ–°æ—¥å¿—"
          }
        }' CHANGELOG.md)
        # ä½¿ç”¨GitHub Actionsè¯­æ³•å¤„ç†å¤šè¡Œå­—ç¬¦ä¸²
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$changelog" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºå‘å¸ƒ # Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: stock_monitor.zip
        tag_name: stock_monitor_${{ steps.get_version.outputs.version }}
        name: stock_monitor_${{ steps.get_version.outputs.version }}
        body: |
          ğŸ¤– stock_monitor_${{ steps.get_version.outputs.version }} å‘å¸ƒè¯´æ˜
          
          > **æœ¬è½¯ä»¶å®Œå…¨ç”±AIè‡ªåŠ¨å¼€å‘ï¼Œå¼€å‘è€…é›¶åŸºç¡€ï¼Œæ‰€æœ‰åŠŸèƒ½å‡ç”±AIæ™ºèƒ½ç”Ÿæˆã€‚**
          
          ${{ steps.extract_changelog.outputs.changelog }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}